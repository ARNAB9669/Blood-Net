const Url_map = {
    "Andaman and Nicobar Islands": "https://script.google.com/macros/s/AKfycbxAcNIJGN_1Spk1c0OAGBBqSGqNm8ODYlsSwZcETuyyRrDOWgBFjZs7i1uVbOhw4eNayg/exec",//done
    "Andhra Pradesh": "https://script.google.com/macros/s/AKfycbw3XyITySHQ90DOXrXr_hERWNllXrX5HAGI8vWhhGnc2t5oE6bqDB2GmDaxD3RjnL7E2w/exec",//done
    "Arunachal Pradesh": "https://script.google.com/macros/s/AKfycbxGlDD_d4EZ7JzEa467KlP8w2Sg0D3wpwZIplkUFCzoMNgWBBw4K_hhqbNvPnaakZIZ/exec",//done
    "Assam": "https://script.google.com/macros/s/AKfycbwK9KqetlEhTuJlGGJj39SF8t1cSxwEumRgvDQ95pCigokt-yQLGs-mlahbV4as-3B3/exec",//done
    "Bihar": "https://script.google.com/macros/s/AKfycbzW8vdVO1OXo2ZBsTB5dNvt1GtpeslgRc2OJ9ll5iaPBtMomV_9JBVAngVFRAjTfoeA/exec",//done
    "Chandigarh": "https://script.google.com/macros/s/AKfycbye0uhFYI_37nSNPJK8nAgxUEdqJZhiEgUk8x7M_evBi0nnTEaMI6RMOGMWdFCNXV5bBw/exec",//done
    "Chhattisgarh": "https://script.google.com/macros/s/AKfycbyfonMz1wlvrILKif-YvQQVdTN_BM0ZCrXGlWIsfrwF3Ed5ZCe2f7weRhIUX5FIGNlE/exec",//done
    "Dadra and Nagar Haveli and Daman and Diu": "https://script.google.com/macros/s/AKfycbyS3kde-AUA9GCB29Y5KWvZiCC0Tn2o1KiAVHkN4AMX-vsFvpWoHYFeXl-XCKwDsOaxKA/exec",//done
    "Delhi": "https://script.google.com/macros/s/AKfycbzNPWadI8y-k5XM9RJsDl_V6wPhAXpuaZMHNW1jS9OleaifPJCQ4tEwrt-eIIZMMC7r-Q/exec",//done
    "Goa": "https://script.google.com/macros/s/AKfycbxh_ewj1IGOrnoUPjpa3rMTkFje7PVSDD2_Ayq4Goae13h3S5oRmwk2sDaXUfcScoQ7kw/exec",//done
    "Gujarat": "https://script.google.com/macros/s/AKfycbxqMRur2_kjzIkFTXXw3S9nnAIOPPVXL0T-7UL_sedKV-e9_VJxrVzGJDknr46rEWQ/exec",//done
    "Haryana": "https://script.google.com/macros/s/AKfycbzYNwvHEfYn_N__UVIMz8wxF2_uDoz014i3ff8GJoGXWOxmXXixNKAM_vGzb0EVXU1BvQ/exec",//done
    "Jammu and Kashmir": "https://script.google.com/macros/s/AKfycbzpljD-p6szV7p17I9kEI8aVIOMX49J_mUpgAKue1_7Ul_4SAwwYBwY8_OfxD98HhhVPQ/exec",//done
    "Azad Kashmir": "https://script.google.com/macros/s/AKfycbyhQUj7gIhkpWlW01InbNMFF4TAZSlXLS8824Axotp4VPYqe69ex6X5Otji4gKNTbwx/exec",//done
    "Himachal Pradesh": "https://script.google.com/macros/s/AKfycbzHoJFmuWWTzDpwP64bq5_joYkyoV5MZSFArIBE9msd_0AYILCgJMw2NOAPzHFxICJr/exec",//done
    "Jharkhand": "https://script.google.com/macros/s/AKfycbxrgBZNPA21YMb5ztKyVznMOjtTkqVQotWo16CgSsApGuymuI3jGLuBywsJhchmNlH0/exec",//done
    "Karnataka": "https://script.google.com/macros/s/AKfycbx5qoA-ykExRmzY56T9xAW8QRuugVWftQUIMK7-mZz_CrKx457NbnQpmbUGRLKExXgMXw/exec",//done
    "Kerala": "https://script.google.com/macros/s/AKfycbw1y597ON28w3l1msIA_QdQzXk1SehL9cBL8ekA7mNnj-GOWbU8uILBvdYImMMQKoLTUg/exec",//done
    "Ladakh": "https://script.google.com/macros/s/AKfycbwKtjDrRPAG0p21SJiq4U9WXJ3CE2gl3tZjAUEO4UAN-FhmunDWEL7J8CBhPL37tU2f/exec",//done
    "Lakshadweep": "https://script.google.com/macros/s/AKfycbzBK_4XkNvB0nKVf175eLE4nHb8d2ZUFsT6RDLBxHYvsCGuvyD1Ny176dUVmVXSvXegBg/exec",//done
    "Madhya Pradesh": "https://script.google.com/macros/s/AKfycbzcanP_SR2zW-Z_XagJXmishdgZNBH0syEkgFDnD-lG2_hYjcR9s0aS0FvVhKEr_aVU/exec",//done
    "Maharashtra": "https://script.google.com/macros/s/AKfycbxZkjg2akTv6cIIUs2W3VA5abD9LdEkOt8ziV_5qaWeCf1Vm6jx80cRi9GCYmz0GATo/exec",//done
    "Manipur": "https://script.google.com/macros/s/AKfycbwiKNlAP2exgKreCyF12gsRhMU0aJ9XC6y6Mw_il-ipuPw93hCKUVPeq2EUi_PADwxv/exec",//done
    "Meghalaya": "https://script.google.com/macros/s/AKfycby370fvUJrpxcMRt1xzV3DeDKrSw6_sIgxdOEn7h1rWc7QbmdG95yHdNutsLxAsyqHNtw/exec",//done
    "Mizoram": "https://script.google.com/macros/s/AKfycbym7pFJpGeKQoUZfAGFWb3Pi4VHe_z-DRZEBM0T1enj5FYmdJG8xZ5egB_KITPOr3hp/exec",//done
    "Nagaland": "https://script.google.com/macros/s/AKfycbzYPIksS_bIodEGwHPtD0irYyM6vRo6FGCFqWoBZWC0K0idYul965mzLNXW3pXvjtrn/exec",//done
    "Odisha": "https://script.google.com/macros/s/AKfycbyF9pfbBudI-3StQBd-qd_TLgXsGLkX-n2Bs7L0l9bikP94WplpQDlH9m7Vx8zf3U8/exec",//done
    "Puducherry": "https://script.google.com/macros/s/AKfycbyKNOgVJ4tEYJ2kGTUlV6uQxtgNfI_2CU7ueZSzFqz_fv2e2cABDyDP0KVyy1lP-LHSHw/exec",//done
    "Punjab": "https://script.google.com/macros/s/AKfycby0YSjZsr2arF4-cooLQPyu2QnpkcGUId-xPpBwpncIioi_N12QYV8no-b8LUPG9qzB8w/exec",//done
    "Rajasthan": "https://script.google.com/macros/s/AKfycbxBmjBxYoxPYYiMV1V3_jStjV7dY622Tdkv9o6I2WKfMU5tpjXYyzKO04R00O9OW8RE/exec",//done
    "Sikkim": "https://script.google.com/macros/s/AKfycbxKj0SToV5oRATF0tgudjiT6EPmRdwGBB8pDh0NnLzLOP4fxx6vL8V5qfxvdFjkLW01eA/exec",//done
    "Tamil Nadu": "https://script.google.com/macros/s/AKfycbzBJzNMR5VxAvmVhnm2szWEPES8BADhF1RjIKGdO6yYpFQ8jzn2kKIdD5xC-3D71cNTIA/exec",//done
    "Telangana": "https://script.google.com/macros/s/AKfycbxbmIatg82AdbGqPw-PMrSnpceBTrjl82JtffHIIO5AePzXa2NicynpNH86GYucN5frBg/exec",//done
    "Tripura": "https://script.google.com/macros/s/AKfycbwkMhPWzXpwSkJejkmOd7WSRgYOyTw0a9P7M7SXA9yqn49AUvRrT8Tx8Ei_aDbOEkDQbQ/exec",//done
    "Uttar Pradesh": "https://script.google.com/macros/s/AKfycbxa0RapIV3j0PmhINZaxmhIa3JRQmmmqPWSEeYLHdDTZduT9Am842i7N5eGF3M0hchk/exec",//done
    "Uttarakhand": "https://script.google.com/macros/s/AKfycbzRuuTp1KCIExgozMdMzghMcHAINM9AwQwBo_gYa3__8igRknI5NIn-8OSQlSLiBDA7vQ/exec",//done
    "West Bengal": "https://script.google.com/macros/s/AKfycbz5oBD3jIqrNgHW-fCbgrk1DgVxdpNuPAL6LXmOzSUWxtSDAGi6aGlOlDXi_IxRgfSqVg/exec"//done
};

document.addEventListener("DOMContentLoaded", () => {
    const params = new URLSearchParams(window.location.search);
    const state = params.get("state");
    const district = params.get("district");
    const blood_group = params.get("blood_group");

    if (!state || !Url_map[state]) {
        alert("Invalid or missing state.");
        return;
    }

    const API_URL = Url_map[state];
    const url = `${API_URL}?state=${encodeURIComponent(state)}&district=${encodeURIComponent(district)}&blood_group=${encodeURIComponent(blood_group)}`;

    console.log("Fetching from URL:", url);

    const loader = document.createElement("div");
    loader.id = "customLoader";
    loader.innerHTML = `
      <div style="display: flex; justify-content: center; align-items: center; height: 100vh;">
        <div style="border: 8px solid #f3f3f3; border-top: 8px solid #00f2ff; border-radius: 50%; width: 60px; height: 60px; animation: spin 1s linear infinite;"></div>
      </div>
      <style>
        @keyframes spin {
          0% { transform: rotate(0deg); }
          100% { transform: rotate(360deg); }
        }
      </style>
    `;
    document.body.appendChild(loader);

    fetch(url)
        .then(res => res.json())
        .then(data => {
            const container = document.getElementById("resultsContainer");
            container.innerHTML = "";

            console.log("Raw data from sheet:", data);

            // ðŸ”Ž Filter again on frontend to ensure correctness
            const filtered = data.filter(donor =>
                (!state || donor["State"]?.toLowerCase() === state.toLowerCase()) &&
                (!district || donor["District"]?.toLowerCase() === district.toLowerCase()) &&
                (!blood_group || donor["Blood_group"]?.toLowerCase() === blood_group.toLowerCase())
            );

            if (!Array.isArray(filtered) || filtered.length === 0) {
                container.innerHTML = "<p>No matching donors found.</p>";
                return;
            }

            filtered.forEach(donor => {
                const card = document.createElement("div");
                card.className = "donor-card";
                card.innerHTML = `
                  <div class="card-content">
                    <div class="donor-name" style="text-align: center; margin-bottom: 10px;">
                      <h2 style="margin: 0; color: #00f2ff;">${donor["First_Name"]} ${donor["Last_Name"]}</h2>
                    </div>
                    <div class="donor-info" style="display: flex;">
                      <div class="donor-details">  
                        <p><strong>Blood Group:</strong> ðŸ©¸${donor["Blood_group"]}</p>
                        <p><strong>State:</strong> ${donor["State"]}</p>
                        <p><strong>District:</strong> ${donor["District"]}</p>
                        <p><strong>City:</strong> ${donor["City"]}</p>
                        <p><strong>Mobile:</strong> ${donor["Phone_number"]}
                          ðŸ‘‰ <button onclick="copyNumber('${donor["Phone_number"]}')" style="margin-left: 5px; cursor: pointer;">
                            <img src="Materials/Ionic-Ionicons-Copy.svg" alt="Click to Copy" style="width: 16px; height: 16px; vertical-align: middle;">
                          </button>
                        </p>
                        <p><strong>Age:</strong> ${donor["Age"]}</p>
                        <p><strong>Sex:</strong> ${donor["Sex"]}</p>
                      </div>
                      <div>
                        <img class="img" src="https://cdn-icons-png.flaticon.com/512/149/149071.png" alt="Profile" style="width: 60px; height: 60px; border-radius: 50%; border: 2px solid #00f2ff;">
                      </div>
                    </div>
                  </div>
                `;
                container.appendChild(card);
            });

            const existingLoader = document.getElementById("customLoader");
            if (existingLoader) existingLoader.remove();
        })
        .catch(err => {
            console.error("Error loading donor data:", err);
            document.getElementById("resultsContainer").innerHTML = "<p>Error loading donor data.</p>";
            const existingLoader = document.getElementById("customLoader");
            if (existingLoader) existingLoader.remove();
        });
});

function copyNumber(number) {
    navigator.clipboard.writeText(number).then(() => {
        const popup = document.createElement("div");
        popup.textContent = "Number copied!";
        popup.style.position = "fixed";
        popup.style.bottom = "20px";
        popup.style.right = "20px";
        popup.style.padding = "10px 15px";
        popup.style.backgroundColor = "#00f2ff";
        popup.style.color = "#000";
        popup.style.borderRadius = "5px";
        popup.style.boxShadow = "0 0 10px #00f2ff";
        popup.style.zIndex = "9999";
        document.body.appendChild(popup);
        setTimeout(() => popup.remove(), 1500);
    });
}